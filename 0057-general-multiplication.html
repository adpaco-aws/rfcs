<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0057-general-multiplication - Cedar RFC Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cedar RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="general-multiplication-in-cedar"><a class="header" href="#general-multiplication-in-cedar">General multiplication in Cedar</a></h1>
<h2 id="related-issues-and-prs"><a class="header" href="#related-issues-and-prs">Related issues and PRs</a></h2>
<ul>
<li>Reference Issues: related to <a href="https://github.com/cedar-policy/rfcs/pull/50">RFC 50</a></li>
<li>Implementation PR(s): <a href="https://github.com/cedar-policy/cedar/pull/702">cedar#702</a></li>
</ul>
<h2 id="timeline"><a class="header" href="#timeline">Timeline</a></h2>
<ul>
<li>Started: 2024-03-07</li>
<li>Accepted: 2024-03-15</li>
<li>Landed: 2024-03-20 in <code>cedar-policy</code></li>
<li>Released: 2024-03-29 in <code>cedar-policy</code> v3.1.2</li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Allow multiplication of arbitrary expressions (that evaluate to Long), not just
multiplication of an expression by a constant.</p>
<h2 id="basic-example"><a class="header" href="#basic-example">Basic example</a></h2>
<pre><code>permit(principal, action, resource) when {
    context.foo * principal.bar &gt;= 100
};
</code></pre>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Today, Cedar only supports multiplication of two operands if (at least) one
operand is a constant.
In the more general n-ary (chained) multiplication case, Cedar requires that at
most one operand is a non-constant, but allows the constants and non-constant to
appear in any order.</p>
<ul>
<li>This creates some confusion for Cedar users. No other popular programming
language has this restriction on multiplication.</li>
<li>This leads to bugs and confusing behavior. To enforce this restriction,
Cedar's internal AST node for multiplication only supports multiplying an
expression by a constant. But this requires the Cedar parser to re-associates
(and re-order) operands in a chained multiplication, which leads to confusion
and problems as described in <a href="https://github.com/cedar-policy/rfcs/pull/50">RFC 50</a>.</li>
<li>This limits the power of Cedar by preventing users from writing policies
involving multiplication where neither operand is known at policy-authoring
time.</li>
</ul>
<p>This RFC proposes to relax all of these restrictions and allow multiplication
of arbitrary expressions (that evaluate to Long).
In other words, multiplication will be treated just like addition: <code>*</code> will be
valid in all positions and situations where <code>+</code> is valid today.</p>
<h2 id="detailed-design"><a class="header" href="#detailed-design">Detailed design</a></h2>
<p>This will actually simplify the evaluator code, validator code, and internal AST.
Multiplication will become an ordinary <code>BinaryOp</code>, and no longer need a special
AST node.
The evaluator and validator can handle multiplication in the same way as
addition and in the same code paths.</p>
<p>With this RFC, the policy parser becomes strictly more permissive:
All policies that currently parse will still parse, plus additional policies
that used to produce parse errors will now parse as well.
There are edge cases where evaluations that do not overflow today could result
in overflows after this RFC -- see Drawbacks below.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>One motivation for the original restriction on multiplication was to make SMT
analysis of Cedar policies easier.
However, presuming that the SMT analysis uses bitvector theory to analyze
operations on Cedar Longs, multiplication by a general expression is not much
more expensive than multiplication by an arbitrary constant (ignoring special
cases such as 0 or constant powers of 2).
Some multiplication expressions will be expensive to analyze (computationally),
but that is already true for some other kinds of Cedar expressions that don't
involve multiplication.
In general, we'd prefer to use a linter to warn users about (these and other)
expensive expressions, rather than use restrictions on the Cedar language.</p>
<p>This RFC firmly closes the door on changing Cedar's default numeric type to
bignum. However, that door is already basically closed.
Also, we could still introduce bignums as an extension type (with their own
separate multiplication operation) in the future.</p>
<p>This RFC has essentially no interaction with any other currently pending or
active RFC, except for <a href="https://github.com/cedar-policy/rfcs/pull/50">RFC 50</a> which it replaces and makes obsolete.</p>
<p>There are edges cases where evaluations that do not overflow today could result
in overflows after this RFC.
One example is an expression <code>CONST * CONST * context.value</code> for large <code>CONST</code>
when <code>context.value == 0</code>.
Today's parser will produce the internal AST <code>(mul (mul context.value CONST) CONST)</code>
which will not overflow when <code>context.value == 0</code>, while this RFC would produce
the internal AST <code>(mul (mul CONST CONST) context.value)</code> which would overflow
even when <code>context.value == 0</code>.
This is because, like <a href="https://github.com/cedar-policy/rfcs/pull/50">RFC 50</a>, this RFC proposes to left-associate
multiplication and not to reorder operands, in contrast to the current Cedar
parser.</p>
<p>This edge case seems very unlikely for users to hit (as it requires a
multiplication by two large constants), and this RFC's proposed behavior is
undoubtedly more intuitive, as multiplication is left-associative in most
programming languages.</p>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<p><a href="https://github.com/cedar-policy/rfcs/pull/50">RFC 50</a> is one alternative which fixes some issues with chained multiplication
without (significantly) relaxing Cedar's restrictions on multiplication
operations.
This RFC's proposal leads to simpler evaluation and validation code than RFC 50,
and also makes the Cedar language simpler and easier to understand for users.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0055-remove-unspecified.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="0062-extended-has.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0055-remove-unspecified.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="0062-extended-has.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
